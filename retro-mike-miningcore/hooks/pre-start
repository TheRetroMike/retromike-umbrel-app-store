#!/usr/bin/env bash
set -euo pipefail

APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

MC_DIR="/home/umbrel/.miningcore"
POOLS_DIR="${MC_DIR}/pools.d"

mkdir -p "${POOLS_DIR}"

seed_if_missing() {
  local src="$1"
  local dst="$2"

  if [[ ! -f "${dst}" ]]; then
    echo "[pre-start] Seeding ${dst} from ${src}"
    cp "${src}" "${dst}"
    chown umbrel:umbrel "${dst}" 2>/dev/null || true
    chmod 0644 "${dst}" 2>/dev/null || true
  fi
}

# Base files (only if missing)
seed_if_missing "${APP_DIR}/assets/config.base.json" "${MC_DIR}/config.base.json"
seed_if_missing "${APP_DIR}/coins.json"             "${MC_DIR}/coins.json"
seed_if_missing "${APP_DIR}/assets/fees.json"       "${MC_DIR}/fees.json"

# Always render config.json (keeps it in sync with pools.d)
echo "[pre-start] Rendering ${MC_DIR}/config.json"
python3 "${APP_DIR}/scripts/render-config.py" || true

# Postgres init (idempotent, with readiness wait)
POSTGRES_CONTAINER="retro-mike-postgres_db_1"

for i in {1..60}; do
  if docker ps --format '{{.Names}}' | grep -q "^${POSTGRES_CONTAINER}$"; then
    if docker exec "${POSTGRES_CONTAINER}" pg_isready -U umbrel -d umbrel >/dev/null 2>&1; then
      break
    fi
  fi
  sleep 1
done

if ! docker ps --format '{{.Names}}' | grep -q "^${POSTGRES_CONTAINER}$"; then
  echo "[pre-start] Postgres container not found; skipping DB init."
  exit 0
fi

if ! docker exec "${POSTGRES_CONTAINER}" pg_isready -U umbrel -d umbrel >/dev/null 2>&1; then
  echo "[pre-start] Postgres not ready; skipping DB init."
  exit 0
fi

echo "[pre-start] Initializing MiningCore schema in Postgres (idempotent)"
docker exec -i "${POSTGRES_CONTAINER}" psql -v ON_ERROR_STOP=1 -U umbrel -d umbrel <<'SQL'
DO $$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'miningcore') THEN
    CREATE ROLE miningcore LOGIN PASSWORD 'miningcore';
  END IF;
END
$$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'miningcore') THEN
    CREATE DATABASE miningcore OWNER miningcore;
  END IF;
END
$$;
SQL

docker exec -i "${POSTGRES_CONTAINER}" psql -v ON_ERROR_STOP=1 -U miningcore -d miningcore < "${APP_DIR}/assets/miningcore.sql"

echo "[pre-start] Done"
