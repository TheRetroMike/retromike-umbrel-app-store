#!/usr/bin/env bash
# MiningCore pre-start hook (Umbrel)
# - Seeds ~/.miningcore with base files if missing
# - Ensures config.json exists (so Docker file mounts don't turn into directories)
# - Ensures Postgres role/db exist and schema is applied (best-effort)
#
# NOTE: We intentionally do NOT use `set -euo pipefail` here.

APP_DATA_DIR="${APP_DATA_DIR:-/home/umbrel/umbrel/app-data/retro-mike-miningcore}"
MC_DIR="/home/umbrel/.miningcore"

log() { echo "[miningcore pre-start] $*"; }
warn() { echo "[miningcore pre-start] WARN: $*" >&2; }

seed_if_missing() {
  local src="$1"
  local dst="$2"
  if [ ! -f "$dst" ] && [ -f "$src" ]; then
    cp -a "$src" "$dst" 2>/dev/null || true
  fi
}

log "Seed base files into $MC_DIR (if missing)"
mkdir -p "$MC_DIR/pools.d" "$MC_DIR/wallet-backups" 2>/dev/null || true

seed_if_missing "$APP_DATA_DIR/coins.json"       "$MC_DIR/coins.json"
seed_if_missing "$APP_DATA_DIR/fees.json"        "$MC_DIR/fees.json"
seed_if_missing "$APP_DATA_DIR/assets/config.base.json" "$MC_DIR/config.base.json"

# Ensure config.json exists (otherwise docker will create a directory at that path)
if [ ! -f "$MC_DIR/config.json" ]; then
  if [ -f "$APP_DATA_DIR/scripts/render-config.py" ]; then
    python3 "$APP_DATA_DIR/scripts/render-config.py" >/dev/null 2>&1 || true
  fi
fi

# Patch DB creds in config(s) to miningcore/miningcore (idempotent)
python3 - <<'PY' 2>/dev/null
import json
from pathlib import Path

def patch(path: Path):
    if not path.exists():
        return
    try:
        d=json.loads(path.read_text())
    except Exception:
        return
    pers=d.get("persistence")
    if not isinstance(pers, dict):
        return
    changed=False
    if pers.get("user") != "miningcore":
        pers["user"]="miningcore"; changed=True
    if pers.get("password") != "miningcore":
        pers["password"]="miningcore"; changed=True
    if pers.get("database") != "miningcore":
        pers["database"]="miningcore"; changed=True
    if changed:
        path.write_text(json.dumps(d, indent=2) + "\n")

patch(Path("/home/umbrel/.miningcore/config.base.json"))
patch(Path("/home/umbrel/.miningcore/config.json"))
PY

# Fix ownership/perms (MiningCore container runs as 1000:1000)
chown -R 1000:1000 "$MC_DIR" 2>/dev/null || true
find "$MC_DIR" -type d -exec chmod 755 {} + 2>/dev/null || true
find "$MC_DIR" -type f -exec chmod 644 {} + 2>/dev/null || true

# Clean stale fragments (optional)
rm -f "$MC_DIR/pools.d/bch.json.disabled" 2>/dev/null || true

# Postgres: ensure role+db exist and schema is applied (best-effort)
POSTGRES_CONTAINER="$(docker ps --filter label=com.docker.compose.project=retro-mike-postgres --format '{{.Names}}' 2>/dev/null | grep '_db_' | head -n1)"
if [ -z "$POSTGRES_CONTAINER" ]; then
  warn "Postgres container for retro-mike-postgres not found. Skipping DB init."
  exit 0
fi

# wait until postgres is ready (up to 60s)
for i in $(seq 1 60); do
  docker exec "$POSTGRES_CONTAINER" pg_isready -U umbrel -d umbrel >/dev/null 2>&1 && break
  sleep 1
done

# role miningcore
docker exec "$POSTGRES_CONTAINER" psql -U umbrel -d umbrel -v ON_ERROR_STOP=1 -tc   "SELECT 1 FROM pg_roles WHERE rolname='miningcore';" 2>/dev/null | grep -q 1   || docker exec "$POSTGRES_CONTAINER" psql -U umbrel -d umbrel -v ON_ERROR_STOP=1 -c   "CREATE ROLE miningcore LOGIN PASSWORD 'miningcore';" >/dev/null 2>&1 || true

# db miningcore
docker exec "$POSTGRES_CONTAINER" psql -U umbrel -d umbrel -v ON_ERROR_STOP=1 -tc   "SELECT 1 FROM pg_database WHERE datname='miningcore';" 2>/dev/null | grep -q 1   || docker exec "$POSTGRES_CONTAINER" psql -U umbrel -d umbrel -v ON_ERROR_STOP=1 -c   "CREATE DATABASE miningcore OWNER miningcore;" >/dev/null 2>&1 || true

# schema (idempotent)
if [ -f "$APP_DATA_DIR/assets/miningcore-schema.sql" ]; then
  cat "$APP_DATA_DIR/assets/miningcore-schema.sql" | docker exec -i "$POSTGRES_CONTAINER"     psql -U umbrel -d miningcore >/dev/null 2>&1 || true
fi

exit 0
